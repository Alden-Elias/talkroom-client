<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>èŠå¤©å®¤</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <!-- æ–° Bootstrap æ ¸å¿ƒ CSS æ–‡ä»¶ -->
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/bootstrap/css/fileinput.min.css" rel="stylesheet">
    <!--datepicker-->
    <link rel="stylesheet" href="/datepicker/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="/datepicker/css/bootstrap-datepicker3.min.css">

    <link href="/css/chat.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.0/font/bootstrap-icons.css">

    <!-- jQueryæ–‡ä»¶ã€‚åŠ¡å¿…åœ¨bootstrap.min.js ä¹‹å‰å¼•å…¥ -->
    <script src="/js/jquery.min.js"></script>
    <!-- æœ€æ–°çš„ Bootstrap æ ¸å¿ƒ JavaScript æ–‡ä»¶ -->
    <!-- <script src="/bootstrap/js/bootstrap.min.js"></script> -->
    <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap/js/fileinput.min.js"></script>
    <script src="/bootstrap/js/fileinput-locales-zh.js"></script>
    <!--datepicker-->
    <script src="/datepicker/js/bootstrap-datepicker.js"></script>
    <script src="/datepicker/locales/bootstrap-datepicker.zh-CN.min.js"></script>

    <script src="/js/axios.min.js"></script>
    <script src="/js/vue.min.js"></script>
</head>

<body class="chat">
    <script type="text/javascript">
        let ws;
        let messageMap = new Map();
        let addFriendRequest = [];
        let globalVar = {messageTo: -1};
        const eventId = {
            //get event id
            addFriend: 1,
            cleanUnreadCount: 2,

            //sent event id
            readMessage: 1,
        }

        $(function WebSocketConn() {
            if ("WebSocket" in window) {
                // æ‰“å¼€ä¸€ä¸ª web socket
                ws = new WebSocket((window.location.protocol == "https:" ? "wss" : "ws") + "://" + window.location.host + "/websocket/message");

                ws.onopen = function () {
                    // Web Socket å·²è¿æ¥ä¸Šï¼Œä½¿ç”¨ send() æ–¹æ³•å‘é€æ•°æ®
                    // alert("è¿æ¥æˆåŠŸ")
                };

                ws.onmessage = function (evt) {
                    let res = JSON.parse(evt.data);

                    if (res.from != 0) {
                        messageMap.get(Number(res.from)).messages.push({ "from": res.from, "time": (new Date()).valueOf(), "msg": res.message });
                        if(globalVar.messageTo != Number(res.from)) {
                            messageMap.get(Number(res.from)).unreadCount++;
                        }else{
                            let req = {
                                "to": globalVar.messageTo,
                                "eventId": eventId.readMessage,
                                "message": null,
                            }
                            ws.send(JSON.stringify(req));
                        }
                    } else {
                        let systemMsg = JSON.parse(res.message);

                        switch(systemMsg.eventId){
                            case eventId.addFriend:
                                const addFriendReq  = systemMsg.json;
                                addFriendRequest.push({ "from": res.from, "time": (new Date()).valueOf(), "token": addFriendReq.token, "uname": addFriendReq.uname, "uid": addFriendReq.uid });
                                console.log(addFriendRequest);
                                break;
                            case eventId.cleanUnreadCount: 
                                messageMap.get(systemMsg.json.uid).unreadCount = 0;
                                break;
                        }
                    }
                };

                ws.onclose = function () {
                    // å…³é—­ websocket
                    // alert("è¿æ¥å·²å…³é—­...");
                    window.location.href = window.location.protocol + "//" + window.location.host + "/login.html";
                };
            }
            else {
                // æµè§ˆå™¨ä¸æ”¯æŒ WebSocket
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebSocket!");
            }
        });

    </script>

    <div class="container" id="main">
        <button id="changeBackgroundColor" class="btn position-absolute top-0 start-0" @click="changeBackgroundColor"
            title="åˆ‡æ¢èƒŒæ™¯é¢œè‰²">
        </button>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div id="personalInfo" class="position-absolute top-0 end-0" data-bs-toggle="modal"
            data-bs-target="#changePersonalInfo">
            <div class="avatarBox" title="ä¿®æ”¹ä¸ªäººä¿¡æ¯">
                <img :src=account.avatar alt="404" data-bs-toggle="tooltip">
            </div>
        </div>

        <!--å¤´éƒ¨-->
        <div class="row" id="header">
            <!--å·¥å…·æ -->
            <div class="col-md-3" id="toolBox">
                <i class="bi bi-chat-left-dots-fill btn" @click="showMessageList"></i>
            </div>

            <!--æœç´ æ¡†-->
            <div id="searchBox" class="col-md-4 offset-md-1">
                <div class="input-group text-center">
                    <button data-bs-toggle="offcanvas" data-bs-target="#userSearchOffcanvas"
                        aria-controls="userSearchOffcanvas">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>


            <!--å±•ç¤º-->
            <div class="col-md-2 offset-md-2" id="chevron" v-if="true">
                <i :class="['bi', 'btn', showSidebarRight>0?'bi-chevron-double-right':'bi-chevron-double-left' ]"
                    @click="showGroupBox"></i>
            </div>
        </div>

        <!--ä¸»ä½“-->
        <div class="row" id="mainBody">
            <!--æ¶ˆæ¯åˆ—è¡¨-->
            <div class="col-md-3" id="messageList">
                <div class="list-group scrollarea">
                    <div v-for="user in users" @click="message_to(user.id)"
                        :class="['list-group-item', user.id==globalVar.messageTo?'bg-light bg-opacity-50':'']" :title="user.id">

                        <div class="avatar">
                            <div class="avatarBox">
                                <img :src=user.avatar alt="404">
                            </div>
                        </div>

                        <div class="messageList-top">
                            <strong>{{user.name}}<span class="badge" style="color: black"><i
                                        class="bi bi-person-fill"></i></span></strong>
                            <div>{{messageMap.get(user.id).messages.length > 0 ?
                                dateFormat(messageMap.get(user.id).messages.at(-1).time, 1) : ''}}</div>

                        </div>
                        <div class="messageList-bottom">
                            <span class="text-truncate">{{messageMap.get(user.id).messages.length > 0 ?
                                messageMap.get(user.id).messages.at(-1).msg : ''}}</span>
                            <div class="badge rounded-pill bg-secondary"v-show="messageMap.get(user.id).unreadCount > 0 && 
                                (messageMap.get(user.id).messages.length > 0 && messageMap.get(user.id).messages.slice(-1)[0].from != account.id)">
                                {{messageMap.get(user.id).unreadCount &lt; 10 ? messageMap.get(user.id).unreadCount
                                    : '9+' }} 
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--æ¶ˆæ¯æ¡†ä¸»ä½“-->
            <div :class="[showSidebarRight>0 ? 'col-md-7' : 'col-md-9']">
                <!--æ¶ˆæ¯æ¡†-->
                <div id="messageBox">
                    <div class="message" v-for="(msg, idx) in curmessageList.messages">
                        <div :class="msg.from==account.id ? 'message-self' : 'message-other'">
                            <div class="avatar" v-if="msg.from!=account.id">
                                <div class="avatarBox">
                                    <img :src="messageMap.get(msg.from).user.avatar" alt="404">
                                </div>
                            </div>
                            <p class="messageContent">
                                <span class="username"
                                    v-if="msg.from!=account.id">{{messageMap.get(msg.from).user.name}}</span>
                                <span class="messageTime badge bg-white bg-opacity-25">{{dateFormat(msg.time, 0)}}</span>
                                <span class="username"
                                    v-if="msg.from==account.id">{{messageMap.get(msg.from).user.name}}</span>
                                <br>

                                <span
                                    :class="['position-relative', 'messageBubble', msg.from==account.id?'bg-primary':'bg-white', 'p-2', 'text-dark', msg.from==account.id?'bg-opacity-25':'bg-opacity-50']">
                                    {{msg.msg}}
                                    <span v-if="idx >= curmessageList.messages.length-curmessageList.unreadCount&&msg.from==account.id" class="unreadPoint position-absolute bottom-0 start-0"></span>
                                </span>
                            </p>

                            <div class="avatar" v-if="msg.from==account.id">
                                <div class="avatarBox">
                                    <img :src="messageMap.get(msg.from).user.avatar" alt="404">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--å‘é€æ¶ˆæ¯æ¡†-->
                <div id="sentBox">
                    <span>
                        <span class="position-relative">
                            <span v-show="showEmojiSpan" class="overflow-auto position-absolute bottom-0 start-0">
                                <span class="emjio" v-for="emoji in emojis"
                                    @click="emojiChoise(emoji)">{{emoji}}</span>
                            </span>
                            <i class="bi bi-emoji-smile-fill btn" @click="showEmojis"></i>
                        </span>
                        <span class="float-end">
                            <i class="bi bi-clock-history btn" @click="showShearchBox"></i>
                        </span>
                        <span class="float-end">
                            <i class="bi bi-person-fill btn" @click="showFriendList"></i>
                        </span>
                    </span>
                    <textarea class="form-control" v-model="sentMsg"></textarea>
                    <button class="btn btn-primary" @click="send_message(sentMsg, globalVar.messageTo)"
                        :disabled="globalVar.messageTo == -1">å‘é€</button>
                </div>
            </div>

            <!--ç¾¤ç»„è¯¦æƒ…è®¾ç½®-->
            <div class="col-md-2 sidebarRight" id="groupBox" v-show="showSidebarRight==1" v-if="true">
                <div id="btnGroup">
                    <i class="bi bi-person-plus-fill btn"></i>
                    <i class="bi bi-pencil-square btn"></i>
                    <i class="bi bi-gear-fill btn"></i>
                </div>

                <div id="announceBox">
                    <div id="announceHeader">
                        <span>ç¾¤å…¬å‘Š</span>
                        <span><i class="bi bi-three-dots btn"></i></span>
                    </div>

                    <div id="announceBody" class="text-truncate">
                        hello world! <br>
                        hello world! <br>hello world! <br>hello world! <br>
                        hello world! <br>hello world! <br>hello world! <br>
                        hello world! <br>hello world! <br>hello world! <br>
                    </div>

                </div>

                <div class="userList list-group">
                    <div id="userSearchBox-group">
                        <label for="userSearch"><i class="bi bi-search"></i></label>
                        <input type="text" id="userSearch" placeholder="æœç´¢">
                    </div>

                    <div class="list-group-item">
                        <div class="avatar">
                            <div class="avatarBox">
                                <img src="/favicon.ico" alt="404">
                            </div>
                        </div>
                        <span class="username">å¼ å°ç…å¼ å°ç…</span>
                        <i class="bi bi-person-fill" style="color: darkorange;"></i>
                    </div>

                </div>

            </div>

            <!-- å¥½å‹åˆ—è¡¨ -->
            <div class="col-md-2 sidebarRight" id="friendList" v-show="showSidebarRight==2">
                <div class="list-group scrollarea">
                    <div class="text-center" id="friendSearchBox-group">
                        <label for="friendSearch"><i class="bi bi-search"></i></label>
                        <input type="text" id="friendSearch" placeholder="æœç´¢å¥½å‹" v-model="filtFriendQuery" @keyup.enter="searchFriend(filtFriendQuery)">
                    </div>
                    <div v-for="user in filtFriends" class="list-group-item" :title="user.id">

                        <div class="avatar">
                            <div class="avatarBox">
                                <img :src=user.avatar alt="404">
                            </div>
                        </div>

                        <div style="line-height: 40px;">
                            <strong>{{user.name}}<span class="badge" style="color: black"><i
                                        class="bi bi-person-fill"></i></span></strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŸ¥æ‰¾å†å²æ¶ˆæ¯ -->
            <div class="col-md-2 sidebarRight" id="historySearch" v-show="showSidebarRight==3">
                <div class="list-group scrollarea">
                    <div class="text-center" id="friendSearchBox-group">
                        <label for="friendSearch"><i class="bi bi-search"></i></label>
                        <input type="text" id="friendSearch" placeholder="æœç´¢å†å²" v-model="filtHistoryQuery" @keyup.enter="searchHistoryMessage(filtHistoryQuery)">
                    </div>
                    <div v-for="msg in filtHistorys" class="list-group-item" :title="msg.msg">

                        <div class="avatar">
                            <div class="avatarBox">
                                <img :src="messageMap.get(msg.from).user.avatar" alt="404">
                            </div>
                        </div>

                        <div style="line-height: 40px;">
                            <span class="text-truncate">{{msg.msg}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ç”¨æˆ·æœç´¢ ä¾§è¾¹æ  -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="userSearchOffcanvas"
        aria-labelledby="userSearchOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="userSearchOffcanvasLabel">æœç´¢å¥½å‹</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- æœç´¢æ¡† -->
            <div class="input-group text-center">
                <label for="search"><span class="input-group-text"><i class="bi bi-search"></i></span></label>
                <input type="text" class="form-control iconfont" id="search" placeholder="æœç´¢"
                    v-model="searchUserQuery" @keyup.enter="searchUser(searchUserQuery)">
            </div>
            <br><br>


            <!-- åˆ—å‡ºç”¨æˆ· -->
            <div class="list-group">

                <div class="list-group-item" v-for="user in searchedUser">
                    <span class="avatar">
                        <div class="avatarBox">
                            <img :src=user.avatar alt="404">
                        </div>
                    </span>
                    <div>
                        <div class="text-truncate">ç”¨æˆ·æ˜µç§°: {{user.name}}</div>
                        <div class="text-truncate">æ³¨å†Œé‚®ç®±: {{user.email}}</div>
                        <a @click="addFriend(user.id)" class="link-success">å‘é€å¥½å‹ç”³è¯·</a>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- ç³»çµ±æ¶ˆæ¯æç¤º åå¸å¼¹å‡ºæ¡† -->
    <div id="toastmessageBox" class="toast-container position-absolute p-3 bottom-0 end-0">

        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true"
            v-for="req in addFriendRequest">
            <div class="toast-header">
                <strong class="me-auto"><i class="bi bi-fire"></i> å¥½å‹éªŒè¯</strong>
                <small class="text-muted">{{dateFormat(req.time,0)}}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span class="btn-sm">
                    <span class="link-primary">{{req.uname}}</span> è¯·æ±‚æ·»åŠ å¥½å‹
                </span>

                <span class="buttonGroup">
                    <button @click="agreeFriend(req.token)" class="btn btn-outline-success btn-sm">åŒæ„</button>
                    <button class="btn btn-outline-secondary btn-sm">å¿½è§†</button>
                </span>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ä¸ªäººä¿¡æ¯ æ¨¡æ€å¼¹çª— -->
    <div class="modal fade" id="changePersonalInfo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">

        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">ä¿®æ”¹ä¸ªäººä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">

                        <!-- å¤´åƒä¸Šä¼  -->
                        <div class="col-md-5">
                            <div style="height: 300px; width: 300px; margin-bottom: 100px;">
                                <input type="file" name="file" id="avatarUpdate" class="file-loading" />
                            </div>
                        </div>

                        <!-- å…¶ä»–ä¸ªäººä¿¡æ¯ -->
                        <div class="col-md-7">
                            <div class="row" style="margin: 15px 0;">
                                <!-- æ˜µç§° -->
                                <div class="col-md">
                                    <label for="nickName" class="form-label">æ˜µç§°</label>
                                    <input type="text" class="form-control" id="nickName"
                                        :placeholder="account.name" v-model="name">
                                </div>
                                <!-- ç”Ÿæ—¥ æ—¶é—´é€‰æ‹©å™¨ -->
                                <div class="col-md">
                                    <label for="birthdayPicker" class="form-label">ç”Ÿæ—¥</label>
                                    <div class="input-group date" id="birthdayPicker">
                                        <input type="text" class="form-control" :placeholder="account.birthday">
                                        <div class="input-group-text"><i class="bi bi-calendar-date"></i></div>

                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-th"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="margin: 15px 0;">
                                <!-- é‚®ç®± -->
                                <div class="col-md-8">
                                    <label for="emailInput" class="form-label">é‚®ç®±</label>
                                    <input type="email" class="form-control-plaintext" id="emailInput" readonly
                                        :value="account.email">
                                </div>

                                <!-- æ€§åˆ« -->
                                <div class="col-md-4">
                                    <label for="sexChoice" class="form-label">æ€§åˆ«</label>
                                    <div id="sexChoice">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="inlineRadioOptions"
                                                id="inlineRadio1" value="ç”·"
                                                :checked="account.sex=='ç”·' ? 'checked' : ''" v-model="sex">
                                            <label class="form-check-label" for="inlineRadio1">ç”·</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="inlineRadioOptions"
                                                id="inlineRadio2" value="å¥³"
                                                :checked="account.sex=='å¥³' ? 'checked' : ''" v-model="sex">
                                            <label class="form-check-label" for="inlineRadio2">å¥³</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" style="margin: 15px;">
                                <label for="personalDescription" class="form-label">ä¸ªæ€§ç­¾å</label>
                                <textarea class="form-control" id="personalDescription" rows="3"
                                    :placeholder="account.description" v-model="description"></textarea>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" @click="savePersonalInfo">ä¿å­˜</button>
                </div>

            </div>
        </div>
    </div>


    <script>
        //ä¸»ä½“æ¡†
        new Vue({
            el: '#main',
            data: {
                showSidebarRight: 0 ,
                sentMsg: "",
                users: [],
                globalVar: globalVar,
                account: null,
                curmessageList: {unreadCount: 0, messages: []},
                messageMap: messageMap,
                backgroundColor: [
                    "linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%)",
                    "linear-gradient(to top, #e6b980 0%, #eacda3 100%)",
                    "linear-gradient(-225deg, #5D9FFF 0%, #B8DCFF 48%, #6BBBFF 100%)",
                    "linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)",
                    "linear-gradient(to right, #fa709a 0%, #fee140 100%)",
                    "linear-gradient(to right, #abbaab, #ffffff)",
                    "linear-gradient(to left, #485563, #29323c)",
                    "linear-gradient(to left, #6441a5, #2a0845)",
                    "linear-gradient(to left, #ffb347, #ffcc33)",
                    "linear-gradient(to left, #83a4d4, #b6fbff)",
                    "linear-gradient(to left, #9d50bb, #6e48aa)",
                    "linear-gradient(to left, #c9ffbf, #ffafbd)",
                    "linear-gradient(to left, #ffefba, #ffffff)",
                    "linear-gradient(to left, #d9a7c7, #fffcdc)",
                ],
                backgroundColorIdx: 1,
                showEmojiSpan: false,
                emojis: ["ğŸ˜€", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ¤£", "ğŸ˜‚", "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‡", "ğŸ¥°", "ğŸ˜", "ğŸ¤©", "ğŸ˜˜", "ğŸ˜—",
                    "ğŸ˜š", "ğŸ˜™", "ğŸ¥²", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜œ", "ğŸ¤ª", "ğŸ˜", "ğŸ¤‘", "ğŸ¤—", "ğŸ¤­", "ğŸ¤«", "ğŸ¤”", "ğŸ¤", "ğŸ¤¨", "ğŸ˜", "ğŸ˜‘",
                    "ğŸ˜¶", "ğŸ˜", "ğŸ˜’", "ğŸ™„", "ğŸ˜¬", "ğŸ¤¥", "ğŸ˜Œ", "ğŸ˜”", "ğŸ˜ª", "ğŸ¤¤", "ğŸ˜´", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤¢", "ğŸ¤®", "ğŸ¤§",
                    "ğŸ¥µ", "ğŸ¥¶", "ğŸ¥´", "ğŸ˜µ", "ğŸ¤¯", "ğŸ¤ ", "ğŸ¥³", "ğŸ¥¸", "ğŸ˜", "ğŸ¤“", "ğŸ§", "ğŸ˜•", "ğŸ˜Ÿ", "ğŸ™", "â˜¹ï¸", "ğŸ˜®", "ğŸ˜¯",
                    "ğŸ˜²", "ğŸ˜³", "ğŸ¥º", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜±", "ğŸ˜–", "ğŸ˜£", "ğŸ˜", "ğŸ˜“", "ğŸ˜©", "ğŸ˜«",
                    "ğŸ¥±", "ğŸ˜¤", "ğŸ˜¡", "ğŸ˜ ", "ğŸ¤¬"],
                showMsgOrFrd: 1,
                filtFriendQuery: "",
                filtFriends: [],
                filtHistoryQuery: "",
                filtHistorys: [],
            },
            created() {
                this.account = JSON.parse(localStorage.getItem("account"));
            },
            mounted() {
                that = this;

                axios.get('/friends/list').then(function (response) {
                    // å¤„ç†æˆåŠŸæƒ…å†µ
                    let res = response.data.data.users;
                    that.users = res;

                    res.forEach(element => {
                        that.messageMap.set(element.id, { "messages": [], "unreadCount": 0, user: element });
                        axios.get('/message/getHistory?to=' + element.id).then(function (response) { //è·å–å†å²ä¿¡æ¯
                            // å¤„ç†æˆåŠŸæƒ…å†µ
                            that.messageMap.get(element.id).unreadCount = response.data.data.unreadCount;
                            let res = response.data.data.messages
                            if (res && res.length > 0) {
                                that.messageMap.get(element.id).messages = res
                            } else if (element.id != that.account.id) {
                                that.messageMap.get(element.id).messages.push({ "from": element.id, "time": (new Date()).valueOf(), "msg": "æˆ‘ä»¬å·²ç»æ˜¯å¥½å‹å•¦ï¼Œä¸€èµ·æ¥èŠå¤©å§ï¼" });
                            }
                        }).catch(function (error) {
                            // å¤„ç†é”™è¯¯æƒ…å†µ
                            that.messageMap.get(element.id).messages.push({ "from": element.id, "time": (new Date()).valueOf(), "msg": "æˆ‘ä»¬å·²ç»æ˜¯å¥½å‹å•¦ï¼Œä¸€èµ·æ¥èŠå¤©å§ï¼" });
                            res = error.response.data;
                            alert(res.msg);
                        }).then(function () {
                            // æ€»æ˜¯ä¼šæ‰§è¡Œ
                        });
                    });

                    // //è¿›å…¥ä¸»ç•Œé¢åç›´æ¥æ˜¾ç¤ºç¬¬ä¸€ä¸ªè§’è‰²æ¶ˆæ¯å¯¹è¯æ¡†
                    // if (res.length > 0) {
                    //     that.globalVar.messageTo = res[0].id;
                    //     that.curmessageList = messageMap.get(res[0].id);
                    // }
                }).catch(function (error) {
                    // å¤„ç†é”™è¯¯æƒ…å†µ
                    console.log("error");
                }).then(function () {
                    // æ€»æ˜¯ä¼šæ‰§è¡Œ
                });
            },
            methods: {
                showGroupBox: function () {
                    this.showSidebarRight = (this.showSidebarRight == 1 ? 0 : 1);
                },
                send_message: function (sentMsg, messageTo) {
                    let data = {
                        message: sentMsg,
                        to: messageTo,
                    };

                    messageMap.get(messageTo).messages.push({ "from": this.account.id, "time": (new Date()).valueOf(), "msg": sentMsg });

                    that = this;
                    axios.post('/message/sent', data).then(function (response) {
                        // å¤„ç†æˆåŠŸæƒ…å†µ
                        that.sentMsg = "";

                        if(messageTo != that.account.id){
                            messageMap.get(messageTo).unreadCount++;
                        }
                    }).catch(function (error) {
                        // å¤„ç†é”™è¯¯æƒ…å†µ
                        res = error.response.data;
                        alert(res.msg);
                    }).then(function () {
                        // æ€»æ˜¯ä¼šæ‰§è¡Œ
                    });
                    //æ»šåŠ¨æ èšç„¦æœ€åº•å±‚ ä¸ç”Ÿæ•ˆ
                    this.scrollToBottom();
                },
                message_to: function (uid) {
                    this.globalVar.messageTo = Number(uid);

                    //æ¥æ”¶æ¶ˆæ¯
                    if((messageMap.get(uid).messages.length > 0 && messageMap.get(uid).messages.slice(-1)[0].from != this.account.id) && messageMap.get(this.globalVar.messageTo).unreadCount > 0){
                        messageMap.get(this.globalVar.messageTo).unreadCount = 0;
                        
                        let req = {
                            "to": this.globalVar.messageTo,
                            "eventId": eventId.readMessage,
                            "message": null,
                        }
                        ws.send(JSON.stringify(req));
                    }
                    this.curmessageList = messageMap.get(this.globalVar.messageTo);

                    //æ»šåŠ¨æ èšç„¦åˆ°æœ€åº•å±‚ ä¸ç”Ÿæ•ˆ
                    this.scrollToBottom();
                },
                scrollToBottom: function () {
                    this.$nextTick(() => {
                        const div = document.getElementById('messageBox');
                        div && (div.scrollTop = div.scrollHeight);
                    })
                },
                dateFormat: function (timestamp, formatType) {
                    let date = new Date(timestamp);

                    Y = date.getFullYear() + '-';
                    M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
                    D = date.getDate() + ' ';
                    h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
                    m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
                    s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
                    if (formatType == 0) {
                        if (new Date().setHours(0, 0, 0, 0) == new Date(timestamp).setHours(0, 0, 0, 0)) {
                            return h + m + s;
                        } else {
                            return M + D + h + m + s;
                        }
                    } else {
                        if (new Date().setHours(0, 0, 0, 0) == new Date(timestamp).setHours(0, 0, 0, 0)) {
                            return (h + m).substring(0, 5);
                        } else {
                            return (M + D).substring(0, 5);
                        }
                    }
                },
                changeBackgroundColor: function () {
                    $("body").css("background-image", this.backgroundColor[this.backgroundColorIdx]);
                    len = this.backgroundColor.length;
                    do {
                        random = Math.floor(Math.random() * len);
                    } while (random == this.backgroundColorIdx);

                    $("#changeBackgroundColor").css("background-image", this.backgroundColor[random]);
                    this.backgroundColorIdx = random;
                },
                emojiChoise: function (s) {
                    this.sentMsg = this.sentMsg + s;
                    this.showEmojiSpan = false;
                },
                showEmojis: function () {
                    this.showEmojiSpan = !this.showEmojiSpan;
                },
                showMessageList: function () {
                    this.showMsgOrFrd = 1;
                },
                showFriendList: function () {
                    this.showSidebarRight = (this.showSidebarRight == 2 ? 0 : 2);
                },
                searchFriend: function(query){
                    this.filtFriends = [];
                    that = this;
                    this.users.forEach(function (user) {
                        if(user.name.search(query) >= 0){
                            that.filtFriends.push(user);
                        }
                    });
                },
                showShearchBox: function(){
                    this.showSidebarRight = (this.showSidebarRight == 3 ? 0 : 3);
                },
                searchHistoryMessage: function(query){
                    this.filtHistorys = [];
                    that = this;
                    this.curmessageList.messages.forEach(function (message) {
                        if(message.msg.search(query) >= 0){
                            that.filtHistorys.push(message);
                        }
                    });
                    console.log(this.filtHistorys);
                }
            }
        })

        //ç”¨æˆ·æœç´¢ ä¾§è¾¹æ 
        new Vue({
            el: "#userSearchOffcanvas",
            data: {
                searchedUser: [],
                searchUserQuery: "",
            },
            methods: {
                searchUser: function (query) {
                    that = this;
                    axios.get('/user/search?query=' + query).then(function (response) {
                        // å¤„ç†æˆåŠŸæƒ…å†µ
                        that.searchedUser = response.data.data.users;
                    }).catch(function (error) {
                        // å¤„ç†é”™è¯¯æƒ…å†µ
                        res = error.response.data;
                        alert(res.msg);
                    }).then(function () {
                        // æ€»æ˜¯ä¼šæ‰§è¡Œ
                    });
                },
                addFriend: function (uid) {
                    axios.post('/friends/add?uid=' + uid).then(function (response) {
                        // å¤„ç†æˆåŠŸæƒ…å†µ
                    }).catch(function (error) {
                        // å¤„ç†é”™è¯¯æƒ…å†µ
                        res = error.response.data;
                        alert(res.msg);
                    }).then(function () {
                        // æ€»æ˜¯ä¼šæ‰§è¡Œ
                    });
                }
            }
        })

        //ç³»ç»Ÿæ¶ˆæ¯æç¤º åå¸æ¶ˆæ¯
        new Vue({
            el: "#toastmessageBox",
            data: {
                addFriendRequest: [],
            },
            mounted() {
                this.addFriendRequest = addFriendRequest;
            },
            methods: {
                agreeFriend: function (token) {
                    that = this;
                    axios.post('/friends/confirm?token=' + token).then(function (response) {
                        // å¤„ç†æˆåŠŸæƒ…å†µ
                    }).catch(function (error) {
                        // å¤„ç†é”™è¯¯æƒ…å†µ
                        res = error.response.data;
                        alert(res.msg);
                    }).then(function () {
                        // æ€»æ˜¯ä¼šæ‰§è¡Œ
                    });
                },
                dateFormat: function (timestamp, formatType) {
                    let date = new Date(timestamp);

                    Y = date.getFullYear() + '-';
                    M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
                    D = date.getDate() + ' ';
                    h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
                    m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
                    s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getMinutes());
                    if (formatType == 0) {
                        if (new Date().setHours(0, 0, 0, 0) == new Date(timestamp).setHours(0, 0, 0, 0)) {
                            return h + m + s;
                        } else {
                            return M + D + h + m + s;
                        }
                    } else {
                        if (new Date().setHours(0, 0, 0, 0) == new Date(timestamp).setHours(0, 0, 0, 0)) {
                            return (h + m).substring(0, 5);
                        } else {
                            return (M + D).substring(0, 5);
                        }
                    }
                },
            }
        })

        //ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
        let avatarUpdate = null; //ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒæ–‡ä»¶ äºŒè¿›åˆ¶å½¢å¼åœ¨ä¸Šä¼ æ—¶åº”å½“è€ƒè™‘æ›´æ”¹ä¸ºbase64ç¼–ç 
        new Vue({
            el: "#changePersonalInfo",
            data: {
                account: null,
                name: "",
                birthday: "",
                sex: "",
                description: ""
            },
            created() {
                this.account = JSON.parse(localStorage.getItem("account"));
            },
            mounted() {
                this.name = this.account.name;
                this.birthday = this.account.birthday;
                this.sex = this.account.sex;
                this.description = this.account.description;
            },
            methods: {
                savePersonalInfo: function () {
                    that = this;
                    let data = {
                        'name': this.name,
                        'birthday': $('#birthdayPicker').find("input").val(),
                        'sex': this.sex,
                        'description': this.description,
                        'avatar': ''
                    }
                    if (avatarUpdate != null) {
                        let reader = new FileReader();
                        reader.readAsDataURL(avatarUpdate);//å‚æ•°ä¸ºä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡ ä¼ å€¼è¿›å»å°±ä¼šè§¦å‘ä»¥ä¸‹onloadæ–¹æ³•
                        reader.onload = function (e) {
                            // e.target.resultä¸ºè½¬æ¢æˆçš„base64ç¼–ç 
                            data.avatar = e.target.result; //å½“srcè¢«èµ‹å€¼ åˆ™è§¦å‘ä»¥ä¸‹æ–¹æ³•

                            axios.put('/account/updateUserInfo', data).then(function (response) {
                                // å¤„ç†æˆåŠŸæƒ…å†µ
                                that.account = response.data.data.account;
                                console.log(that.account);
                                localStorage.setItem("account", JSON.stringify(response.data.data.account));
                                location.reload();
                            }).catch(function (error) {
                                // å¤„ç†é”™è¯¯æƒ…å†µ
                                res = error.response.data;
                                alert(res.msg);
                            }).then(function () {
                                // æ€»æ˜¯ä¼šæ‰§è¡Œ
                            });
                        }
                    } else {
                        axios.put('/account/updateUserInfo', data).then(function (response) {
                            // å¤„ç†æˆåŠŸæƒ…å†µ
                            that.account = response.data.data.account;
                            console.log(that.account);
                            localStorage.setItem("account", JSON.stringify(response.data.data.account));
                            location.reload();
                        }).catch(function (error) {
                            // å¤„ç†é”™è¯¯æƒ…å†µ
                            res = error.response.data;
                            alert(res.msg);
                        }).then(function () {
                            // æ€»æ˜¯ä¼šæ‰§è¡Œ
                        });
                    }

                    console.log(data);
                    console.log(this.account);
                }
            }
        })

        $('#avatarUpdate').fileinput({
            language: 'zh',     //è®¾ç½®è¯­è¨€
            dropZoneEnabled: true,      //æ˜¯å¦æ˜¾ç¤ºæ‹–æ‹½åŒºåŸŸ
            showUpload: false,
            showClose: false,
            showUploadedThumbs: false,
            dropZoneTitle: "å¯å°†å›¾ç‰‡æ‹–æ”¾è‡³æ­¤",    //æ‹–æ‹½åŒºåŸŸæ˜¾ç¤ºæ–‡å­—
            allowedFileExtensions: ['jpg', 'png', 'gif', 'jpeg'],   //æŒ‡å®šä¸Šä¼ æ–‡ä»¶ç±»å‹
            maxFileSize: 2048,   //ä¸Šä¼ æ–‡ä»¶æœ€å¤§å€¼ï¼Œå•ä½kb
            uploadAsync: true,  //å¼‚æ­¥ä¸Šä¼ 
            maxFileCount: 1    //ä¸Šä¼ æ–‡ä»¶æœ€å¤§ä¸ªæ•°ã€‚
        }).on("filebatchselected", function (event, files) { //å¼‚æ­¥ä¸Šä¼ æˆåŠŸåå›è°ƒ
            avatarUpdate = files[0];
        }).on("filecleared", function () {
            avatarUpdate = null;
        });

        var $date = $("#birthdayPicker");
        $(document).ready(function () {
            $date.datepicker({
                language: "zh-CN", //ä¸­æ–‡
                autoclose: true, //è‡ªåŠ¨å…³é—­
                todayHighlight: true, //å½“å¤©é«˜äº®
                format: "yyyy-mm-dd" //æ—¥æœŸæ ¼å¼
            });
            $date.datepicker('setDate', new Date());
            $date.datepicker('setStartDate', new Date(1949, 10, 1));
            $date.datepicker('setEndDate', new Date());
            $date.datepicker('clearDates', new Date());
        });
    </script>
</body>

</html>